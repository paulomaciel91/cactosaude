version: '3.8'

services:
    # Frontend
    web:
        image: jitsi/web:latest
        restart: ${RESTART_POLICY:-unless-stopped}
        ports:
            - '${HTTP_PORT:-80}:80'
            - '${HTTPS_PORT:-443}:443'
        volumes:
            - ${CONFIG}/web:/config
            - ${CONFIG}/web/letsencrypt:/etc/letsencrypt
            - ${CONFIG}/transcripts:/usr/share/jitsi-meet/transcripts
        environment:
            - ENABLE_AUTH=${ENABLE_AUTH:-0}
            - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
            - ENABLE_LETSENCRYPT=${ENABLE_LETSENCRYPT:-0}
            - ENABLE_HTTP_REDIRECT=${ENABLE_HTTP_REDIRECT:-0}
            - ENABLE_TRANSCRIPTIONS=${ENABLE_TRANSCRIPTIONS:-0}
            - DISABLE_HTTPS=${DISABLE_HTTPS:-0}
            - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
            - LETSENCRYPT_DOMAIN=${LETSENCRYPT_DOMAIN:-}
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
            - PUBLIC_URL=${PUBLIC_URL:-}
            - TZ=${TZ:-UTC}
            - XMPP_DOMAIN=${XMPP_DOMAIN:-}
            - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-}
            - XMPP_BOSH_URL_BASE=${XMPP_BOSH_URL_BASE:-http://xmpp.meet.jitsi:5280}
            - XMPP_GUEST_DOMAIN=${XMPP_GUEST_DOMAIN:-guest.meet.jitsi}
            - XMPP_MUC_DOMAIN=${XMPP_MUC_DOMAIN:-muc.meet.jitsi}
            - XMPP_RECORDER_DOMAIN=${XMPP_RECORDER_DOMAIN:-recorder.meet.jitsi}
            - ETHERPAD_URL_BASE=${ETHERPAD_URL_BASE:-}
            - ENABLE_IPV6=${ENABLE_IPV6:-0}
            - ENABLE_P2P=${ENABLE_P2P:-true}
            - ENABLE_PREJOIN_PAGE=${ENABLE_PREJOIN_PAGE:-false}
            - ENABLE_WELCOME_PAGE=${ENABLE_WELCOME_PAGE:-false}
            - ENABLE_CLOSE_PAGE=${ENABLE_CLOSE_PAGE:-false}
            - ENABLE_RECORDING=${ENABLE_RECORDING:-false}
            - ENABLE_BREAKOUT_ROOMS=${ENABLE_BREAKOUT_ROOMS:-false}
            - ENABLE_LOBBY=${ENABLE_LOBBY:-false}
            - ENABLE_WATERMARK=${ENABLE_WATERMARK:-false}
            - ENABLE_BRAND_WATERMARK=${ENABLE_BRAND_WATERMARK:-false}
        networks:
            - meet.jitsi

    # XMPP server
    prosody:
        image: jitsi/prosody:latest
        restart: ${RESTART_POLICY:-unless-stopped}
        ports:
            - '${XMPP_PORT:-5222}:5222'
        volumes:
            - ${CONFIG}/prosody/config:/config
            - ${CONFIG}/prosody/prosody-plugins-custom:/prosody-plugins-custom
        environment:
            - AUTH_TYPE=${AUTH_TYPE:-internal}
            - ENABLE_AUTH=${ENABLE_AUTH:-0}
            - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
            - GLOBAL_MODULES=${GLOBAL_MODULES:-}
            - GLOBAL_CONFIG=${GLOBAL_CONFIG:-}
            - LDAP_URL=${LDAP_URL:-}
            - LDAP_BASE=${LDAP_BASE:-}
            - LDAP_BINDDN=${LDAP_BINDDN:-}
            - LDAP_BINDPW=${LDAP_BINDPW:-}
            - LDAP_FILTER=${LDAP_FILTER:-}
            - LDAP_AUTH_METHOD=${LDAP_AUTH_METHOD:-}
            - LDAP_VERSION=${LDAP_VERSION:-}
            - LDAP_USE_TLS=${LDAP_USE_TLS:-}
            - LDAP_TLS_CIPHERS=${LDAP_TLS_CIPHERS:-}
            - LDAP_TLS_CHECKPEER=${LDAP_TLS_CHECKPEER:-}
            - LDAP_TLS_CACERT_FILE=${LDAP_TLS_CACERT_FILE:-}
            - LDAP_TLS_CACERT_DIR=${LDAP_TLS_CACERT_DIR:-}
            - LDAP_START_TLS=${LDAP_START_TLS:-}
            - XMPP_DOMAIN=${XMPP_DOMAIN:-}
            - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-}
            - XMPP_GUEST_DOMAIN=${XMPP_GUEST_DOMAIN:-guest.meet.jitsi}
            - XMPP_MUC_DOMAIN=${XMPP_MUC_DOMAIN:-muc.meet.jitsi}
            - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
            - XMPP_MODULES=${XMPP_MODULES:-}
            - XMPP_MUC_MODULES=${XMPP_MUC_MODULES:-}
            - XMPP_INTERNAL_MUC_MODULES=${XMPP_INTERNAL_MUC_MODULES:-}
            - XMPP_RECORDER_DOMAIN=${XMPP_RECORDER_DOMAIN:-recorder.meet.jitsi}
            - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET:-}
            - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
            - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-}
            - JVB_AUTH_USER=${JVB_AUTH_USER:-jvb}
            - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-}
            - JIGASI_XMPP_USER=${JIGASI_XMPP_USER:-jigasi}
            - JIGASI_XMPP_PASSWORD=${JIGASI_XMPP_PASSWORD:-}
            - JIBRI_XMPP_USER=${JIBRI_XMPP_USER:-jibri}
            - JIBRI_XMPP_PASSWORD=${JIBRI_XMPP_PASSWORD:-}
            - JIBRI_RECORDER_USER=${JIBRI_RECORDER_USER:-recorder}
            - JIBRI_RECORDER_PASSWORD=${JIBRI_RECORDER_PASSWORD:-}
            - TZ=${TZ:-UTC}
        networks:
            - meet.jitsi

    # Focus component
    jicofo:
        image: jitsi/jicofo:latest
        restart: ${RESTART_POLICY:-unless-stopped}
        volumes:
            - ${CONFIG}/jicofo:/config
        environment:
            - ENABLE_AUTH=${ENABLE_AUTH:-0}
            - ENABLE_SCTP=${ENABLE_SCTP:-1}
            - XMPP_DOMAIN=${XMPP_DOMAIN:-}
            - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-}
            - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
            - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
            - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
            - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD:-}
            - JICOFO_RESERVATION_REST_BASE_URL=${JICOFO_RESERVATION_REST_BASE_URL:-}
            - JVB_BREWERY_MUC=${JVB_BREWERY_MUC:-jvbbrewery}
            - JIGASI_BREWERY_MUC=${JIGASI_BREWERY_MUC:-jigasibrewery}
            - JIGASI_SIP_URI=${JIGASI_SIP_URI:-}
            - JIGASI_SIP_PASSWORD=${JIGASI_SIP_PASSWORD:-}
            - JIGASI_SIP_SERVER=${JIGASI_SIP_SERVER:-}
            - JIGASI_SIP_TRANSPORT=${JIGASI_SIP_TRANSPORT:-}
            - TZ=${TZ:-UTC}
        depends_on:
            - prosody
        networks:
            - meet.jitsi

    # Video bridge
    jvb:
        image: jitsi/jvb:latest
        restart: ${RESTART_POLICY:-unless-stopped}
        ports:
            - '${JVB_PORT:-10000}:10000/udp'
            - '${JVB_TCP_PORT:-4443}:4443/tcp'
        volumes:
            - ${CONFIG}/jvb:/config
        environment:
            - DOCKER_HOST_ADDRESS=${DOCKER_HOST_ADDRESS:-}
            - ENABLE_APIS=${ENABLE_APIS:-}
            - ENABLE_COLIBRI_WEBSOCKET=${ENABLE_COLIBRI_WEBSOCKET:-true}
            - ENABLE_HEALTH_CHECKS=${ENABLE_HEALTH_CHECKS:-true}
            - COLIBRI_REST_ENABLED=${COLIBRI_REST_ENABLED:-true}
            - SHUTDOWN_REST_ENABLED=${SHUTDOWN_REST_ENABLED:-true}
            - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-}
            - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
            - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
            - JVB_AUTH_USER=${JVB_AUTH_USER:-jvb}
            - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD:-}
            - JVB_BREWERY_MUC=${JVB_BREWERY_MUC:-jvbbrewery}
            - JVB_PORT=${JVB_PORT:-10000}
            - JVB_TCP_HARVESTER_DISABLED=${JVB_TCP_HARVESTER_DISABLED:-}
            - JVB_TCP_PORT=${JVB_TCP_PORT:-4443}
            - JVB_STUN_SERVERS=${JVB_STUN_SERVERS:-}
            - JVB_ENABLE_APIS=${JVB_ENABLE_APIS:-}
            - TZ=${TZ:-UTC}
        depends_on:
            - prosody
        networks:
            - meet.jitsi

networks:
    meet.jitsi:
        driver: bridge

